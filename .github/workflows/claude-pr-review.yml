name: Claude PR Review

on:
  workflow_call:
    inputs:
      claude_model:
        description: "Claude model to use for review"
        required: false
        default: "claude-sonnet-4-20250514"
        type: string
      claude_temperature:
        description: "Temperature for Claude responses (0-1)"
        required: false
        default: "0"
        type: string
      claude_max_tokens:
        description: "Maximum tokens for Claude response"
        required: false
        default: "8192"
        type: string
      prompt_gist_url:
        description: "URL to fetch prompt template from"
        required: false
        default: "https://gist.githubusercontent.com/DerivFE/048e18e3d2e8c0cddf4c3f434835d57f/raw/claude-review-format.md"
        type: string
    secrets:
      ANTHROPIC_API_KEY:
        description: "Anthropic API key for Claude"
        required: true

jobs:
  claude-review-api:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    concurrency:
      group: claude-pr-review-${{ github.event.pull_request.number }}
      cancel-in-progress: true

    env:
      CLAUDE_MODEL: ${{ inputs.claude_model }}
      CLAUDE_TEMPERATURE: ${{ inputs.claude_temperature }}
      CLAUDE_MAX_TOKENS: ${{ inputs.claude_max_tokens }}

    steps:
      - name: Security Check - Validate User Access
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ACTOR="${{ github.actor }}"
          echo "üîí Validating access for user: $ACTOR"

          MEMBERSHIP=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/orgs/regentmarkets/members/$ACTOR" -w "%{http_code}" -o /dev/null)
          [[ "$MEMBERSHIP" == "204" ]] && echo "‚úÖ Verified org member" && exit 0

          COLLAB=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/collaborators/$ACTOR" -w "%{http_code}" -o /dev/null)
          [[ "$COLLAB" == "204" ]] && echo "‚úÖ Verified collaborator" && exit 0

          echo "‚ùå Access denied for user: $ACTOR" && exit 1

      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 20
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch prompt template from Gist
        id: fetch-prompt
        env:
          PROMPT_GIST_URL: ${{ inputs.prompt_gist_url }}
        run: |
          PROMPT_TEMPLATE=$(curl -sL "$PROMPT_GIST_URL")
          [[ -z "$PROMPT_TEMPLATE" ]] && echo "‚ùå Failed to fetch prompt" && exit 1

          PROMPT_TEMPLATE=$(echo "$PROMPT_TEMPLATE" | sed '1s/^prompt:[[:space:]]*|[[:space:]]*//' | sed 's/^____$//g' | sed 's/____$//g')

          PR_URL="https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"
          PR_HASH=$(echo -n "$PR_URL" | base64 -w0 | tr '+/' '-_' | tr -d '=')
          PROMPT_TEMPLATE=$(echo "$PROMPT_TEMPLATE" | sed "s|{{AUTO_FIX_URL}}|https://click2fix.internal-gcp-ai-agents.deriv.dev/?hash=${PR_HASH}|g")

          { echo 'prompt<<EOF'; echo "$PROMPT_TEMPLATE"; echo 'EOF'; } >> $GITHUB_OUTPUT

      - name: Capture and cleanup previous review
        id: previous-review
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # Capture previous review before deleting
          PREVIOUS=$(gh api "repos/${REPO}/issues/${PR_NUMBER}/comments" \
            --jq '.[] | select(.user.login == "github-actions[bot]" and (.body | contains("Claude PR Review Complete"))) | .body' 2>/dev/null || echo "")

          if [ -n "$PREVIOUS" ]; then
            echo "$PREVIOUS" > /tmp/previous_review.txt
            echo "has_previous=true" >> $GITHUB_OUTPUT

            # Extract the last reviewed commit SHA from the previous review metadata
            LAST_REVIEWED_SHA=$(echo "$PREVIOUS" | grep -oP '(?<=<!-- reviewed-commit: )[a-f0-9]+(?= -->)' || echo "")
            echo "last_reviewed_sha=$LAST_REVIEWED_SHA" >> $GITHUB_OUTPUT
          else
            echo "" > /tmp/previous_review.txt
            echo "has_previous=false" >> $GITHUB_OUTPUT
            echo "last_reviewed_sha=" >> $GITHUB_OUTPUT
          fi

          # Delete old comments
          gh api "repos/${REPO}/issues/${PR_NUMBER}/comments" \
            --jq '.[] | select(.user.login == "github-actions[bot]" and (.body | contains("Claude PR Review Complete"))) | .id' 2>/dev/null | \
            xargs -I {} gh api "repos/${REPO}/issues/comments/{}" -X DELETE 2>/dev/null || true

      - name: Fetch acknowledged suggestions
        id: acknowledged
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"

          echo "üîç Scanning for Click2Fix - Acknowledge comments..."

          # Find comments containing "Click2Fix - Acknowledge" and extract bullet points
          ACKNOWLEDGE_COMMENT=$(gh api "repos/${REPO}/issues/${PR_NUMBER}/comments" \
            --jq '.[] | select(.body | contains("Click2Fix - Acknowledge")) | .body' 2>/dev/null || echo "")

          if [ -n "$ACKNOWLEDGE_COMMENT" ]; then
            echo "‚úÖ Found acknowledge comment"

            # Extract bullet points (lines starting with - or *) using printf for safer handling
            ACKNOWLEDGED_ITEMS=$(printf '%s\n' "$ACKNOWLEDGE_COMMENT" | grep -E '^\s*[-*]\s+' | sed 's/^\s*[-*]\s*//' || echo "")

            if [ -n "$ACKNOWLEDGED_ITEMS" ]; then
              printf '%s\n' "$ACKNOWLEDGED_ITEMS" > /tmp/acknowledged_items.txt
              echo "has_acknowledged=true" >> $GITHUB_OUTPUT
              echo "üìã Acknowledged items:"
              printf '%s\n' "$ACKNOWLEDGED_ITEMS"
            else
              echo "" > /tmp/acknowledged_items.txt
              echo "has_acknowledged=false" >> $GITHUB_OUTPUT
              echo "‚ÑπÔ∏è No bullet items found in acknowledge comment"
            fi
          else
            echo "" > /tmp/acknowledged_items.txt
            echo "has_acknowledged=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No Click2Fix - Acknowledge comment found"
          fi

      - name: Get PR context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          LAST_REVIEWED_SHA: ${{ steps.previous-review.outputs.last_reviewed_sha }}
          HAS_PREVIOUS: ${{ steps.previous-review.outputs.has_previous }}
        run: |
          gh pr diff "$PR_NUMBER" --repo "$REPO" > /tmp/pr_diff_raw.txt 2>/dev/null || echo "Unable to fetch diff" > /tmp/pr_diff_raw.txt
          gh pr view "$PR_NUMBER" --repo "$REPO" --json files --jq '.files[].path' 2>/dev/null | head -50 > /tmp/changed_files.txt || true
          echo "$PR_TITLE" > /tmp/pr_title.txt
          echo "$PR_AUTHOR" > /tmp/pr_author.txt
          echo "$PR_BRANCH" > /tmp/pr_branch.txt

          # Filter noise files from the diff ‚Äî generated, vendored, lock, test, and
          # style files add bulk with zero review value. We strip their hunks entirely,
          # keeping only the "diff --git" header line so the changed-files list stays accurate.
          NOISE_PATTERN='package-lock\.json|yarn\.lock|pnpm-lock\.yaml|\.snap|\.min\.js|\.min\.css|dist/|build/|\.generated\.|__generated__|/vendor/|\.pb\.go|_test\.snap|\.spec\.(tsx?|jsx?)|/__tests__/|\.scss$|\.md$'
          awk -v noise="$NOISE_PATTERN" '
            /^diff --git / {
              in_noise = ($0 ~ noise)
              if (!in_noise) print
              next
            }
            !in_noise { print }
          ' /tmp/pr_diff_raw.txt > /tmp/pr_diff.txt

          RAW_SIZE=$(wc -c < /tmp/pr_diff_raw.txt)
          FILTERED_SIZE=$(wc -c < /tmp/pr_diff.txt)
          echo "üìä Diff: ${RAW_SIZE} bytes raw ‚Üí ${FILTERED_SIZE} bytes after noise filtering"

          # Generate incremental diff (changes since last review) for follow-up reviews
          echo "" > /tmp/incremental_diff.txt
          if [[ "$HAS_PREVIOUS" == "true" && -n "$LAST_REVIEWED_SHA" ]]; then
            echo "üìã Generating incremental diff since last reviewed commit: $LAST_REVIEWED_SHA"
            if git cat-file -e "$LAST_REVIEWED_SHA" 2>/dev/null; then
              git diff "$LAST_REVIEWED_SHA"..HEAD > /tmp/incremental_diff_raw.txt 2>/dev/null || echo "" > /tmp/incremental_diff_raw.txt
              # Apply same noise filter to incremental diff
              awk -v noise="$NOISE_PATTERN" '
                /^diff --git / {
                  in_noise = ($0 ~ noise)
                  if (!in_noise) print
                  next
                }
                !in_noise { print }
              ' /tmp/incremental_diff_raw.txt > /tmp/incremental_diff.txt
              if [ -s /tmp/incremental_diff.txt ]; then
                echo "‚úÖ Incremental diff generated"
              else
                echo "‚ÑπÔ∏è No changes since last reviewed commit"
              fi
            else
              echo "‚ö†Ô∏è Last reviewed commit $LAST_REVIEWED_SHA not found in history (fetch-depth may be too shallow)"
            fi
          fi

          # Store current HEAD SHA for embedding in the review comment
          CURRENT_SHA=$(git rev-parse HEAD)
          echo "$CURRENT_SHA" > /tmp/current_sha.txt
          echo "üìå Current HEAD: $CURRENT_SHA"

      - name: Call Claude API
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PROMPT_TEMPLATE: ${{ steps.fetch-prompt.outputs.prompt }}
          HAS_PREVIOUS: ${{ steps.previous-review.outputs.has_previous }}
          HAS_ACKNOWLEDGED: ${{ steps.acknowledged.outputs.has_acknowledged }}
        run: |
          echo "ü§ñ Calling Claude API..."

          CHANGED_FILES=$(cat /tmp/changed_files.txt)
          PR_TITLE=$(cat /tmp/pr_title.txt)
          PR_AUTHOR=$(cat /tmp/pr_author.txt)
          PR_BRANCH=$(cat /tmp/pr_branch.txt)
          ACKNOWLEDGED_ITEMS=$(cat /tmp/acknowledged_items.txt)

          # Move full prompt template to system prompt ‚Äî cleanly separates instructions
          # from data and enables Anthropic prompt caching across repeated calls
          printf '%s' "$PROMPT_TEMPLATE" > /tmp/system_prompt.txt

          # Cap the diff at 500 KB ‚Äî at ~4 chars/token this is ~125K tokens, well within
          # Claude Sonnet's 200K context window while leaving room for system prompt + output.
          # Noise filtering above handles most large PRs before this cap is ever reached.
          DIFF_SIZE=$(wc -c < /tmp/pr_diff.txt)
          DIFF_CAP=500000
          if [ "$DIFF_SIZE" -gt "$DIFF_CAP" ]; then
            echo "‚ö†Ô∏è Diff is ${DIFF_SIZE} bytes ‚Äî truncating to ${DIFF_CAP} bytes"
            PR_DIFF=$(head -c "$DIFF_CAP" /tmp/pr_diff.txt)
            PR_DIFF="${PR_DIFF}

          [...diff truncated at ${DIFF_CAP} bytes (${DIFF_SIZE} total). Review remaining files manually.]"
          else
            PR_DIFF=$(cat /tmp/pr_diff.txt)
          fi

          # Build previous-review section (follow-up mode only).
          # Strip bot comment boilerplate before re-sending to reduce token cost.
          if [[ "$HAS_PREVIOUS" == "true" ]]; then
            echo "üìã Follow-up review mode"
            PREVIOUS_REVIEW=$(sed \
              -e '/^## ü§ñ Claude PR Review Complete$/d' \
              -e '/^\*\*Model:\*\*/d' \
              -e '/^\*Review generated via Claude API\*$/d' \
              -e '/^<!-- reviewed-commit:.*-->$/d' \
              /tmp/previous_review.txt)
            PREV_SECTION="---PREVIOUS_REVIEW---
          ${PREVIOUS_REVIEW}
          ---END_PREVIOUS_REVIEW---"
          else
            echo "üìã Initial review mode"
            PREV_SECTION=""
          fi

          # Build acknowledged section if exists
          if [[ "$HAS_ACKNOWLEDGED" == "true" ]]; then
            echo "‚úÖ Including acknowledged items to skip"
            ACKNOWLEDGED_SECTION="---ACKNOWLEDGED_SUGGESTIONS---
          The following suggestions have been acknowledged by the developer and should NOT be included in your review. Do not mention or suggest these items again:
          ${ACKNOWLEDGED_ITEMS}
          ---END_ACKNOWLEDGED_SUGGESTIONS---"
          else
            ACKNOWLEDGED_SECTION=""
          fi

          # Build incremental diff section for follow-up reviews
          if [[ "$HAS_PREVIOUS" == "true" && -s /tmp/incremental_diff.txt ]]; then
            echo "üìã Including incremental diff"
            INCREMENTAL_DIFF=$(cat /tmp/incremental_diff.txt)
            INCREMENTAL_SECTION="---INCREMENTAL_DIFF---
          The following diff shows ONLY the changes made since the last review. Use this to identify what was explicitly fixed.
          If a problematic code pattern appears in a \`-\` line here, it was removed by the fix commit.
          If a pattern does NOT appear here at all, the fix commit did NOT touch it.
          \`\`\`diff
          ${INCREMENTAL_DIFF}
          \`\`\`
          ---END_INCREMENTAL_DIFF---"
          else
            INCREMENTAL_SECTION=""
          fi

          # User message contains only dynamic PR data; instructions live in system prompt
          USER_PROMPT="${PREV_SECTION}

          ${INCREMENTAL_SECTION}

          ${ACKNOWLEDGED_SECTION}

          ## Pull Request Information
          - **Title:** ${PR_TITLE}
          - **Author:** ${PR_AUTHOR}
          - **Branch:** ${PR_BRANCH}

          ## Changed Files
          ${CHANGED_FILES}

          ## Diff
          \`\`\`diff
          ${PR_DIFF}
          \`\`\`"

          printf '%s' "$USER_PROMPT" > /tmp/user_prompt.txt
          echo "üìè System: $(wc -c < /tmp/system_prompt.txt) bytes | User: $(wc -c < /tmp/user_prompt.txt) bytes"

          # Build JSON payload using --rawfile so large strings are never passed as
          # CLI arguments ‚Äî avoids the ARG_MAX (E2BIG) error on large diffs
          jq -n \
            --arg model "$CLAUDE_MODEL" \
            --argjson max_tokens "$CLAUDE_MAX_TOKENS" \
            --argjson temperature "$CLAUDE_TEMPERATURE" \
            --rawfile system /tmp/system_prompt.txt \
            --rawfile user /tmp/user_prompt.txt \
            '{model: $model, max_tokens: ($max_tokens | tonumber), temperature: ($temperature | tonumber), system: $system, messages: [{role: "user", content: $user}]}' \
            > /tmp/payload.json

          # Send payload from file ‚Äî avoids ARG_MAX on `curl -d` with large payloads
          HTTP_CODE=$(curl -s -w "%{http_code}" -o /tmp/api_response.json \
            "https://api.anthropic.com/v1/messages" \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d @/tmp/payload.json)

          [[ "$HTTP_CODE" != "200" ]] && echo "‚ùå API failed: $HTTP_CODE" && cat /tmp/api_response.json && exit 1

          # Parse response from file ‚Äî avoids ARG_MAX on large API responses
          REVIEW=$(jq -r '.content[0].text // empty' /tmp/api_response.json)
          [[ -z "$REVIEW" ]] && echo "‚ùå Empty response" && exit 1

          echo "$REVIEW" > /tmp/review.txt
          echo "‚úÖ Review generated ($(wc -c < /tmp/review.txt) bytes)"

      - name: Post Review Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HAS_PREVIOUS: ${{ steps.previous-review.outputs.has_previous }}
        run: |
          REVIEW=$(cat /tmp/review.txt)
          CURRENT_SHA=$(cat /tmp/current_sha.txt)
          [[ "$HAS_PREVIOUS" == "true" ]] && REVIEW_TYPE="üîÑ Follow-up Review" || REVIEW_TYPE="üìã Initial Review"

          COMMENT="## ü§ñ Claude PR Review Complete

          **Model:** \`$CLAUDE_MODEL\` | **Review Type:** ${REVIEW_TYPE}

          ---

          $REVIEW

          ---
          *Review generated via Claude API*
          <!-- reviewed-commit: ${CURRENT_SHA} -->"

          gh pr comment ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --body "$COMMENT"
          echo "‚úÖ Posted (reviewed commit: ${CURRENT_SHA})"
